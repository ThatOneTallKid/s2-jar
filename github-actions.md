# Setting Up Github Actins for CI/CD

GitHub Actions makes it easy to automate all your software workflows, now with world-class CI/CD. Build, test, and deploy your code right from GitHub. Make code reviews, branch management, and issue tracking work the way you want.

## Checklist
- [x]  JFrog setup
- [x] Setup GitHub Actions
- [x] Setup local 
- [x] Publish Jar

## JFrog Setup

We will be using JFrog Artifactory to store our artifacts.
As a Maven repository, Artifactory is both a source for artifacts needed for a build, and a target to deploy artifacts generated in the build process. By using Artifactory as your Maven repository you gain consistent and reliable access to remote Maven resources, optimized builds with exhaustive information for fully reproducible builds, security and access control,  sharing of internal and external artifacts and more.

**To set-up Jfrog follow the below youtube tutorial**

Creating a Maven Repository With JFrog Artifactory - [Link](https://www.youtube.com/watch?v=aKiOi0ook5o)

Don't forget to save the generated `settings.xml` file in your system so that we can configure the parent settings in the github actions.
Also you need to save the deployment elements. To deploy build artifacts through Artifactory you need to add a deployment element with the URL of a target local repository to which you want to deploy your artifacts


## Setting up our project for Github Actions

### **1. mvn folder for local configurations**
A personalized maven project needs its own parent `settings.xml` file loacted at the `.m2` folder as such to facilitate publishing and packaging process.

So we will need to add a `.mvn` folder in this case inside the project folder, `s2-app` and `s2-core` in this case.

*Contents of `.mvn` folder*
```
~ .mvn
--maven.config
--local-settings.xml
```

The `.mvn/maven.config` file must specify the local   `settings.xml` file for the project to use it during further processes.

### **maven.config**
```
--settings ./.mvn/local-settings.xml
```

<br/>

### **local-settings.xml**
paste the content of the `settings.xml` file generated by JFrog Artifactory

```
<?xml version="1.0" encoding="UTF-8"?>
<settings xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 http://maven.apache.org/xsd/settings-1.2.0.xsd" xmlns="http://maven.apache.org/SETTINGS/1.2.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <servers>
        <server>
            <username>1905222@kiit.ac.in</username>
            <password>AKCp8kr1GsJEGSKBD5FqPyHxNtKviJpPw5h7FzbH4HQeAh6WdkcQ1mEWZZH42pgrQAAcXUBdm</password>
            <id>central</id>
        </server>
        <server>
            <username>1905222@kiit.ac.in</username>
            <password>AKCp8kr1GsJEGSKBD5FqPyHxNtKviJpPw5h7FzbH4HQeAh6WdkcQ1mEWZZH42pgrQAAcXUBdm</password>
            <id>snapshots</id>
        </server>
    </servers>
    <profiles>
        <profile>
            <repositories>
                <repository>
                    <snapshots>
                        <enabled>false</enabled>
                    </snapshots>
                    <id>central</id>
                    <name>default-s2-libs-release</name>
                    <url>https://s2app.jfrog.io/artifactory/default-s2-libs-release</url>
                </repository>
                <repository>
                    <snapshots />
                    <id>snapshots</id>
                    <name>default-s2-libs-snapshot</name>
                    <url>https://s2app.jfrog.io/artifactory/default-s2-libs-snapshot</url>
                </repository>
            </repositories>
            <pluginRepositories>
                <pluginRepository>
                    <snapshots>
                        <enabled>false</enabled>
                    </snapshots>
                    <id>central</id>
                    <name>default-s2-libs-release</name>
                    <url>https://s2app.jfrog.io/artifactory/default-s2-libs-release</url>
                </pluginRepository>
                <pluginRepository>
                    <snapshots />
                    <id>snapshots</id>
                    <name>default-s2-libs-snapshot</name>
                    <url>https://s2app.jfrog.io/artifactory/default-s2-libs-snapshot</url>
                </pluginRepository>
            </pluginRepositories>
            <id>artifactory</id>
        </profile>
    </profiles>
    <activeProfiles>
        <activeProfile>artifactory</activeProfile>
    </activeProfiles>

    <mirrors>
        <mirror>
            <id>maven-default-http-blocker</id>
            <mirrorOf>dummy</mirrorOf>
            <name>Dummy mirror to override default blocking mirror that blocks http</name>
            <url>http://0.0.0.0/</url>
        </mirror>
    </mirrors>
</settings>

```

### Note: Most of NM's repository are in HTTP protocol which is not supported thus we need to add mirrors to our original settings.xml

This problem can be further understood by the following answer (ref: StackOverflow)

<br/>

> More and more repositories use HTTPS nowadays, but this hasn’t always been the case. This means that Maven Central contains POMs with custom repositories that refer to a URL over HTTP. This makes downloads via such repository a target for a MITM attack. At the same time, developers are probably not aware that for some downloads an insecure URL is being used. Because uploaded POMs to Maven Central are immutable, a change for Maven was required. To solve this, we extended the mirror configuration with parameter, and we added a new external:http:* mirror selector (like existing external:*), meaning “any external URL using HTTP”. The decision was made to block such external HTTP repositories by default: this is done by providing a mirror in the conf/settings.xml blocking insecure HTTP external URLs.

<br/>

This must be added to the original `settings.xml`
```
<mirrors>
        <mirror>
            <id>maven-default-http-blocker</id>
            <mirrorOf>dummy</mirrorOf>
            <name>Dummy mirror to override default blocking mirror that blocks http</name>
            <url>http://0.0.0.0/</url>
        </mirror>
    </mirrors>
```

<br/>

## Setting up the workflow
---------------------

Now, that we have set up the local environment for the actions, we now must set-up github to facilitate CI/CD.

We first need to set-up a custom actions with an empty `.yaml` file.

Then paste the following code inside it.

```
name: Publish package to JFrog Artifactory
on:
  release:
    types: [published]
jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
      
      - name: Publish package s2-app
        working-directory: ./s2-java/s2-app
        run: mvn --batch-mode deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish package s2-core
        working-directory: ./s2-java/s2-core
        run: mvn --batch-mode deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

```

Now, every time we publish a release of the s2 packages, github action will automatically publish it to JFrog Artifactory.    